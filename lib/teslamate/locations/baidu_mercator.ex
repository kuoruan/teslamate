defmodule TeslaMate.Locations.BaiduMercator do
  @moduledoc """
  百度坐标系转换工具。
  在 BD09（百度坐标系）和 BD09MC（百度墨卡托坐标系）之间进行转换。

  参考资料：
  https://github.com/CntChen/tile-lnglat-transform
  https://github.com/46319943/BD09Convertor
  https://github.com/tschaub/projzh
  """

  # 坐标转换常量
  @llband [75, 60, 45, 30, 15, 0]

  @mcband [1.289059486e7, 8_362_377.87, 5_591_021, 3_481_989.83, 1_678_043.12, 0]

  # LL2MC 转换因子（经纬度转墨卡托）
  @ll2mc [
    [
      -0.0015702102444,
      111_320.7020616939,
      1_704_480_524_535_203.0,
      -10_338_987_376_042_340.0,
      26_112_667_856_603_880.0,
      -35_149_669_176_653_700.0,
      26_595_700_718_403_920.0,
      -10_725_012_454_188_240.0,
      1_800_819_912_950_474.0,
      82.5
    ],
    [
      8.277824516172526e-4,
      111_320.7020463578,
      6.477955746671607e8,
      -4.082003173641316e9,
      1.077490566351142e10,
      -1.517187553151559e10,
      1.205306533862167e10,
      -5.124939663577472e9,
      9.133119359512032e8,
      67.5
    ],
    [
      0.00337398766765,
      111_320.7020202162,
      4_481_351.045890365,
      -2.339375119931662e7,
      7.968221547186455e7,
      -1.159649932797253e8,
      9.723671115602145e7,
      -4.366194633752821e7,
      8_477_230.501135234,
      52.5
    ],
    [
      0.00220636496208,
      111_320.7020209128,
      51_751.86112841131,
      3_796_837.749470245,
      992_013.7397791013,
      -1_221_952.21711287,
      1_340_652.697009075,
      -620_943.6990984312,
      144_416.9293806241,
      37.5
    ],
    [
      -3.441963504368392e-4,
      111_320.7020576856,
      278.2353980772752,
      2_485_758.690035394,
      6_070.750963243378,
      54_821.18345352118,
      9_540.606633304236,
      -2_710.55326746645,
      1_405.483844121726,
      22.5
    ],
    [
      -3.218135878613132e-4,
      111_320.7020701615,
      0.00369383431289,
      823_725.6402795718,
      0.46104986909093,
      2_351.343141331292,
      1.58060784298199,
      8.77738589078284,
      0.37238884252424,
      7.45
    ]
  ]

  # MC2LL 转换因子（墨卡托转经纬度）
  @mc2ll [
    [
      1.410526172116255e-8,
      8.98305509648872e-6,
      -1.9939833816331,
      200.9824383106796,
      -187.2403703815547,
      91.6087516669843,
      -23.38765649603339,
      2.57121317296198,
      -0.03801003308653,
      1.73379812e7
    ],
    [
      -7.435856389565537e-9,
      8.983055097726239e-6,
      -0.78625201886289,
      96.32687599759846,
      -1.85204757529826,
      -59.36935905485877,
      47.40033549296737,
      -16.50741931063887,
      2.28786674699375,
      1.026014486e7
    ],
    [
      -3.030883460898826e-8,
      8.98305509983578e-6,
      0.30071316287616,
      59.74293618442277,
      7.357984074871,
      -25.38371002664745,
      13.45380521110908,
      -3.29883767235584,
      0.32710905363475,
      6_856_817.37
    ],
    [
      -1.981981304930552e-8,
      8.983055099779535e-6,
      0.03278182852591,
      40.31678527705744,
      0.65659298677277,
      -4.44255534477492,
      0.85341911805263,
      0.12923347998204,
      -0.04625736007561,
      4_482_777.06
    ],
    [
      3.09191371068437e-9,
      8.983055096812155e-6,
      6.995724062e-5,
      23.10934304144901,
      -2.3663490511e-4,
      -0.6321817810242,
      -0.00663494467273,
      0.03430082397953,
      -0.00466043876332,
      2_555_164.4
    ],
    [
      2.890871144776878e-9,
      8.983055095805407e-6,
      -3.068298e-8,
      7.47137025468032,
      -3.53937994e-6,
      -0.02145144861037,
      -1.234426596e-5,
      1.0322952773e-4,
      -3.23890364e-6,
      826_088.5
    ]
  ]

  @doc """
  将 BD09 坐标转换为 BD09MC（百度墨卡托）坐标。
  """
  def ll_to_mc(lon, lat) do
    if lon > 180 or lon < -180 or lat > 90 or lat < -90 do
      {0, 0}
    else
      lon = get_loop(lon, -180, 180)
      lat = get_range(lat, -74, 74)

      factors =
        case Enum.find_index(@llband, fn band -> lat >= band end) do
          # 处理负数纬度情况
          nil -> Enum.find_index(@llband, fn band -> lat <= -band end)
          index -> index
        end
        |> case do
          nil -> nil
          index -> Enum.at(@ll2mc, index)
        end

      transform(lon, lat, factors)
    end
  end

  @doc """
  将 BD09MC（百度墨卡托）坐标转换为 BD09 坐标。
  """
  def mc_to_ll(x, y) do
    abs_y = abs(y)

    factors =
      case Enum.find_index(@mcband, fn band -> abs_y >= band end) do
        nil -> nil
        index -> Enum.at(@mc2ll, index)
      end

    transform(x, y, factors)
  end

  # 私有辅助函数

  # 限制值在指定范围内
  @spec get_range(number(), number(), number()) :: number()
  defp get_range(v, min, max) when max > min do
    min(max(v, min), max)
  end

  defp get_range(v, _min, _max), do: v

  # 将值循环限制在 [min, max] 范围内。
  @spec get_loop(number(), number(), number()) :: number()
  defp get_loop(v, min, max) when max > min do
    diff = max - min

    cond do
      v > max -> get_loop(v - diff, min, max)
      v < min -> get_loop(v + diff, min, max)
      true -> v
    end
  end

  defp get_loop(v, _min, _max), do: v

  defp transform(x, y, factors) when is_list(factors) do
    [f0, f1, f2, f3, f4, f5, f6, f7, f8, f9] = factors

    xt = f0 + f1 * abs(x)
    cc = abs(y) / f9

    yt =
      f2 +
        f3 * cc +
        f4 * :math.pow(cc, 2) +
        f5 * :math.pow(cc, 3) +
        f6 * :math.pow(cc, 4) +
        f7 * :math.pow(cc, 5) +
        f8 * :math.pow(cc, 6)

    xt = if x < 0, do: -xt, else: xt
    yt = if y < 0, do: -yt, else: yt

    {xt, yt}
  end

  defp transform(x, y, _factors), do: {x, y}
end
